<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Title</title>
  <meta name=save content=history>
  <meta name=viewport content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no">
  <meta name=format-detection content="telephone=no">
  <meta name=apple-mobile-web-app-capable content=yes>
  <meta name=apple-mobile-web-app-status-bar-style content=blank>
  <meta http-equiv=Content-Type content="text/html; charset=utf-8">
  <meta charset=utf-8>
  <link rel="stylesheet" href="../../demo/css/style.css">
</head>
<body>
<!--<button onclick="RE.setBold()">点我加粗</button>-->
<button onclick="RE.getEditHtml()">点我获取html</button>
<button onclick="RE.setQuota()">引用</button>
<button onclick="RE.setBullets()">无序</button>
<button onclick="RE.setNumbers()">有序</button>
<button onclick="RE.setBold()">加粗</button>
<button onclick="RE.setItalic()">斜体</button>
<button onclick="RE.undo()">撤销</button>
<!--<button onclick="tinymce.activeEditor.execCommand('mceMedia');">无序列表</button>-->
<!--<button onclick="RE.replaceLink()">无序列表</button>-->
<button onclick="RE.insertLink('http://www.baidu.com','测试一下插入链接')">插入链接</button>
<button onclick="insertImage()">插入图片</button>
<button onclick="insertVideo()">插入视频</button>
<div id="mytextarea"></div>
<!--<script src="http://libs.baidu.com/zepto/0.8/zepto.min.js"></script>-->
<script src="https://libs.baidu.com/jquery/2.0.0/jquery.min.js"></script>
<script type="text/javascript" src="../../main/js/rich_editor.js"></script>
<script src="../../../../../../js/tinymce/tinymce.js"></script>
<script type="text/javascript">
  window.is_in_quote = 0
  tinymce.init({
    selector: '#mytextarea',
    mobile: {
      inline: true,
      menubar: false,
      plugins: ['lists', 'autolink', 'image', 'code', 'preview', 'link', 'noneditable', 'hr', 'media', 'advlist', 'wordcount'],
      statusbar: false,
      toolbar: [],
      contextmenu: '',
      placeholder: '请输入内容...',
      content_css: '../../demo/css/style.css',
      content_css_cors: true,
      fullscreen: false,
      height: window.screen.height,
      editor_css: "../../demo/css/style.css",
      remove_trailing_brs: true,
      auto_focus: true,
      branding: false,
    },
    setup: function (editor) {
      editor.on('click', function (e) {

        // 查找鼠标当前选中的段落的所有样式
        RE.enabledEditingItems()

        // 视频点击样式
        var currentNode = tinymce.activeEditor.selection.getNode();

        // 点击非视频区域，视频选中样式取消
        if ((currentNode && !currentNode.classList.contains('qf_insert_video')) || (currentNode.children[0] && !currentNode.children[0].classList.contains('qf_insert_video'))) {
          $('#mytextarea').find('.qf_insert_video').removeClass('borderline')
          $('#mytextarea').find('.closeImg').remove()
        }

        // 点击非图片区域，图片选中样式取消
        if ((currentNode && !currentNode.classList.contains('qf_image')) || (currentNode.children[0] && !currentNode.children[0].classList.contains('qf_image'))) {
          $('#mytextarea').find('.qf_image').removeClass('borderline')
          $('#mytextarea').find('.closeImg').remove()
          $('#mytextarea').find('.qf_img_operate').remove()
        }

      })
      editor.on('mousedown', function (e) {
      })
      editor.on('input', function (e) {
        if(window.is_in_quote > 0){window.is_in_quote -= 1}
        RE.callback()
      })
      editor.on('keyup', function (e) {

        var currentNode = tinymce.activeEditor.selection.getNode();
        var KEY_DELETE = 8; // 删除键
        var KEY_BACK = 13; // 换行
        // if (e.which === KEY_BACK) {
        //   // 回车的时候有引用样式记录下
        //   if(RE.hasQuoteStyle()){
        //     window.is_in_quote += 1
        //     if(window.is_in_quote >= 2){
        //       console.log('引用状态下回车了两次')
        //       RE.setQuota()
        //     }
        //   }
        //   // 回车的时候给到状态处理
        //   RE.enabledEditingItems()
        // }

        // 删除键逻辑
        if (e.which === KEY_DELETE) {

          RE.whiteBlockHandle(currentNode)

          RE.enabledEditingItems()

        }


        // 光标不在视频上，就取消选中的状态
        if (currentNode.children[0] && !currentNode.children[0].classList.contains('qf_insert_video')) {
          let $ = tinymce.dom.DomQuery;
          $('.qf_insert_video').removeClass('borderline')
          $('.closeImg').remove()
        }
      })
      editor.on('change', function (e) {
        console.log('change')
        // RE.callback()
      })
    }
  });

  function insertImage() {
    let obj = {
      'name': '20200428_1354_1588064712337.jpg',
      'poster': '20200428_1354_1588064712337.jpg?imageslim|imageView2/1/w/420/h/747',
      'w': 420,
      'h': 747,
      'host': 'https://qiance.qianfanyun.com/',
    }

    let re = []
    re.push(obj)
    // RE.insertVideo(JSON.stringify(obj))
    RE.insertAllImages(JSON.stringify(re))
  }

  function insertVideo() {
    let obj = {
      'name': '20200428_1354_1588064712337.jpg',
      'poster': '20200428_1354_1588064712337.jpg?imageslim|imageView2/1/w/420/h/747',
      'w': 420,
      'h': 747,
      'host': 'https://qiance.qianfanyun.com/',
    }

    RE.insertVideo(JSON.stringify(obj))
  }

  $('.qf-video-test,.qf-video').each(function () {
    var $this = $(this);
    var w = $('body').width();
    var h = w / 1.33;//设置宽高比例为1.33
    $this.css({'width': w, 'height': h});
  });


  window.onload = function () {
    const script = document.createElement('script')
    script.src = 'https://cdnjs.cloudflare.com/ajax/libs/jquery.lazyload/1.9.1/jquery.lazyload.min.js'
    script.onload = script.onreadystatechange = function () {
      /*懒加载*/
      $('.lazy').lazyload({
        "effect": "fadeIn",
        "placeholder_real_img": "",
        "placeholder_data_img": "",
        "load": function (e) {
          $(e).css({
            "background-color": "#FFFFFF",
            "background-image": "none"
          });
        }
      });
    }

    document.body.appendChild(script);
  };

</script>
</body>
</html>
